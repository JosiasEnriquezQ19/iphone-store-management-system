<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security" lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Comprobante - IphoneStore</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" th:href="@{/styles.css}">
    <style>
        body {
            background: linear-gradient(rgba(30,30,30,0.70), rgba(30,30,30,0.70)),
                url('https://wallpapers.com/images/hd/apple-logo-in-3d-silver-design-i0fezrk90tf76l69.jpg');
            background-size: cover;
            background-position: center;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
        }
        .sidebar {
            min-height: 100vh;
            background: rgba(30, 30, 30, 0.92);
            color: #fff;
            padding-top: 2rem;
            box-shadow: 2px 0 16px rgba(0,0,0,0.07);
            backdrop-filter: blur(2px);
        }
        .sidebar .navbar-brand {
            font-size: 1.7rem;
            font-weight: 600;
            color: #fff;
            letter-spacing: 1px;
            text-decoration: none;
        }
        .sidebar .nav-link {
            color: #e0e0e0;
            font-size: 1.08rem;
            margin-bottom: 1rem;
            border-radius: 10px;
            padding: 12px 18px;
            transition: background 0.2s, color 0.2s, box-shadow 0.2s;
            text-decoration: none;
        }
        .sidebar .nav-link.active, .sidebar .nav-link:hover {
            background: rgba(255,255,255,0.10);
            color: #fff;
            box-shadow: 0 2px 8px 0 rgba(78,115,223,0.08);
        }
        .sidebar .nav-link i {
            margin-right: 10px;
        }
        .brand-logo {
            width: 38px;
            margin-right: 12px;
            filter: grayscale(1) brightness(1.2);
        }
        .main-content {
            padding: 2.5rem 2rem;
        }
        .card {
            border-radius: 18px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.10);
            border: none;
            background: rgba(255,255,255,0.92);
            backdrop-filter: blur(2px);
        }
        .card-header {
            background: transparent;
            border-bottom: 1px solid rgba(0,0,0,0.125);
            color: #222;
            border-radius: 18px 18px 0 0 !important;
        }
        .alert {
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 12px;
            color: #222;
        }
        .alert-success {
            background: rgba(40, 167, 69, 0.1);
            color: #155724;
        }
        .alert-danger {
            background: rgba(220, 53, 69, 0.1);
            color: #721c24;
        }
        .alert-info {
            background: rgba(78,115,223,0.07);
            color: #222;
        }
        .page-title {
            color: white;
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        .page-subtitle {
            color: rgba(255,255,255,0.8);
            margin-bottom: 2rem;
        }
        .info-label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }
        .info-value {
            font-size: 1rem;
            color: #212529;
            margin-bottom: 1rem;
        }
        .table {
            background: rgba(255,255,255,0.95);
            border-radius: 12px;
            overflow: hidden;
        }
        .table thead th {
            background: rgba(248,249,250,0.9);
            border-top: none;
            font-weight: 600;
        }
        .form-control, .form-select {
            border-radius: 12px;
            border: 1px solid rgba(0,0,0,0.1);
            background: rgba(255,255,255,0.9);
        }
        .form-control:focus, .form-select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
        }
        .btn-primary {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            border: none;
            border-radius: 12px;
        }
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            border-radius: 12px;
        }
        .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            border: none;
            border-radius: 12px;
        }
        .btn-outline-secondary {
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }
        .producto-info {
            display: flex;
            align-items: center;
        }
        .producto-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #007bff, #0056b3);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
        }
        .comprobante-preview {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 15px;
            text-align: center;
        }
        .table tbody td { vertical-align: middle; }
        .d-flex-center { display: flex; align-items: center; justify-content: center; }
        .gap-1 { gap: .5rem; }
        @media (max-width: 991.98px) {
            .main-content {
                padding: 1.2rem 0.5rem;
            }
        }
        @media (max-width: 767.98px) {
            .sidebar {
                position: static;
                width: 100%;
                min-height: auto;
                flex-direction: row !important;
                padding: 1rem 0.5rem;
                overflow-x: auto;
            }
            .sidebar .navbar-brand {
                margin-bottom: 0;
                font-size: 1.2rem;
            }
            .sidebar .nav-link {
                margin-bottom: 0.5rem;
                font-size: 0.98rem;
                padding: 8px 10px;
            }
            .main-content {
                padding: 1rem 0.2rem;
            }
            .page-title {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-lg-3 col-md-4 sidebar d-flex flex-column align-items-start">
                <a class="navbar-brand d-flex align-items-center mb-4" href="#">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/f/fa/Apple_logo_black.svg" alt="Apple Logo" class="brand-logo">
                    <span>IphoneStore</span>
                </a>
                <a th:href="@{/menu}" class="nav-link"><i class="bi bi-house-door-fill"></i> Menú Principal</a>
                <a th:href="@{/productos/listar}" class="nav-link" sec:authorize="hasAuthority('PRODUCTO_READ')"><i class="bi bi-phone-fill"></i> Productos</a>
                <a th:href="@{/Cliente/listar}" class="nav-link" sec:authorize="hasAuthority('CLIENTE_READ')"><i class="bi bi-people-fill"></i> Clientes</a>
                <a th:href="@{/proveedores/listar}" class="nav-link" sec:authorize="hasAuthority('PROVEEDOR_READ')"><i class="bi bi-truck"></i> Proveedores</a>
                <a th:href="@{/pedidos/listar}" class="nav-link" sec:authorize="hasAuthority('PEDIDO_READ')"><i class="bi bi-bag-check-fill"></i> Pedidos</a>
                <a th:href="@{/comprobantes/listar}" class="nav-link active" sec:authorize="hasAuthority('COMPROBANTE_READ')"><i class="bi bi-receipt-cutoff"></i> Comprobantes</a>
                <a th:href="@{/usuarios/listar}" class="nav-link" sec:authorize="hasAuthority('USUARIO_READ')"><i class="bi bi-person-gear"></i> Usuarios</a>
                <a th:href="@{/login}" class="nav-link text-danger"><i class="bi bi-box-arrow-right"></i> Cerrar Sesión</a>
                <div class="mt-auto w-100 text-center text-muted small pt-5">
                    © 2025 IphoneStore. Todos los derechos reservados.
                </div>
            </nav>
            
            <!-- Main Content -->
            <main class="col-lg-9 col-md-8 main-content">
                <!-- Título principal -->
                <div class="d-flex align-items-center mb-4">
                    <h2 class="mb-0">
                        <i class="bi bi-receipt-cutoff"></i> Crear Comprobante
                    </h2>
                </div>

                <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="bi bi-check-circle me-1"></i>
                    <span th:text="${success}">Operación exitosa</span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-triangle me-1"></i>
                    <span th:text="${error}">Error</span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>

                <form th:action="@{/comprobantes/guardar}" method="post" id="comprobanteForm">
                    <input type="hidden" name="pedidoId" th:value="${pedido.idPedido}">
                    <div class="row g-4">
                        <!-- Datos del Pedido Origen -->
                        <div class="col-lg-7">
                            <div class="card mb-4">
                                <div class="card-body">
                                    <div class="mb-3">
                                        <span class="fw-semibold text-secondary"><i class="bi bi-info-circle me-1"></i>Datos del Pedido</span>
                                    </div>
                                    <div class="row g-2">
                                        <div class="col-md-6">
                                            <div class="small text-muted">Cliente</div>
                                            <div class="fw-semibold" th:text="${pedido.cliente?.nombre}">Cliente</div>
                                            <div class="text-muted small" th:text="${pedido.cliente?.documento}">Documento</div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="small text-muted">Fecha Pedido</div>
                                            <div class="fw-semibold" th:text="${#temporals.format(pedido.fechaPedido, 'dd/MM/yyyy')}">01/01/2024</div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="small text-muted">Tipo de Pago</div>
                                            <div class="fw-semibold" th:text="${pedido.tipoPago}">Efectivo</div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="small text-muted">Total Pedido</div>
                                            <div class="fw-semibold text-success" th:text="'S/ ' + ${#numbers.formatDecimal(pedido.totalPagar,1,2)}">S/ 0.00</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Productos del Comprobante -->
                            <div class="card mb-4">
                                <div class="card-body">
                                    <div class="mb-3">
                                        <span class="fw-semibold text-secondary"><i class="bi bi-box-seam me-1"></i>Productos del Comprobante</span>
                                    </div>
                                    <div th:if="${detalles == null or #lists.isEmpty(detalles)}" class="text-center py-5">
                                        <i class="bi bi-inbox display-1 text-muted opacity-25"></i>
                                        <h5 class="text-muted mt-3">No hay productos en este pedido</h5>
                                        <p class="text-muted">No se puede generar comprobante sin productos</p>
                                    </div>
                                    <div th:if="${detalles != null and !#lists.isEmpty(detalles)}" class="table-responsive">
                                        <table class="table table-hover align-middle" id="detallesTable">
                                            <thead>
                                                <tr>
                                                    <th>Producto</th>
                                                    <th>Precio Unit.</th>
                                                    <th>Cantidad</th>
                                                    <th>Subtotal</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr th:each="detalle, iterStat : ${detalles}">
                                                    <td>
                                                        <div class="producto-info">
                                                            <div class="producto-icon">
                                                                <i class="bi bi-phone text-white"></i>
                                                            </div>
                                                            <div>
                                                                <div class="fw-medium" th:text="${detalle.producto?.modelo}">iPhone 15 Pro</div>
                                                                <small class="text-muted">
                                                                    <span th:text="${detalle.producto?.procesador}">A17 Pro</span> - 
                                                                    <span th:text="${detalle.producto?.ram}">8GB</span> - 
                                                                    <span th:text="${detalle.producto?.almacenamiento}">256GB</span>
                                                                </small>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="fw-medium text-primary" th:text="'S/. ' + ${#numbers.formatDecimal(detalle.precioUnitario,1,2)}">S/. 0.00</span>
                                                        <input type="hidden" th:name="'detalles[' + ${iterStat.index} + '].precioUnitario'" th:value="${detalle.precioUnitario}">
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-success" th:text="${detalle.cantidad}">1</span>
                                                        <span class="text-muted small">uds.</span>
                                                        <input type="hidden" th:name="'detalles[' + ${iterStat.index} + '].cantidad'" th:value="${detalle.cantidad}">
                                                        <input type="hidden" th:name="'detalles[' + ${iterStat.index} + '].producto.idProducto'" th:value="${detalle.producto?.idProducto}">
                                                    </td>
                                                    <td>
                                                        <span class="fw-bold text-success" th:text="'S/. ' + ${#numbers.formatDecimal(detalle.precioUnitario * detalle.cantidad,1,2)}">S/. 0.00</span>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Resumen del Comprobante -->
                        <div class="col-lg-5">
                            <div class="card mb-4">
                                <div class="card-body text-center">
                                    <div class="mb-2 fw-semibold text-secondary"><i class="bi bi-receipt me-1"></i>Resumen del Comprobante</div>
                                    <div class="comprobante-preview mb-3">
                                        <div class="fs-5 text-white-50">Total del Comprobante</div>
                                        <div class="display-5 fw-bold" id="totalDisplay">S/ 0.00</div>
                                        <div class="text-white-50 small">Incluye IGV</div>
                                    </div>
                                    <div class="row text-start mb-2">
                                        <div class="col-6">Subtotal:</div>
                                        <div class="col-6 text-end" id="subtotalDisplay">S/ 0.00</div>
                                        <div class="col-6">IGV (18%):</div>
                                        <div class="col-6 text-end" id="igvDisplay">S/ 0.00</div>
                                    </div>
                                    <input type="hidden" id="subtotal" name="subtotal" value="0">
                                    <input type="hidden" id="igv" name="igv" value="0">
                                    <input type="hidden" id="totalPagar" name="totalPagar" value="0">
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="tipoComprobante" class="form-label fw-bold">Tipo de Comprobante *</label>
                                        <select id="tipoComprobante" name="tipoComprobante" class="form-select" required>
                                            <option value="">Seleccionar tipo...</option>
                                            <option value="BOLETA">BOLETA</option>
                                            <option value="FACTURA">FACTURA</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="numeroComprobante" class="form-label fw-bold">Número de Comprobante</label>
                                        <input type="text" id="numeroComprobante" name="numeroComprobante" class="form-control" 
                                            placeholder="Se generará automáticamente" readonly>
                                        <small class="text-info">
                                            <i class="bi bi-info-circle"></i> Se asignará automáticamente al guardar
                                        </small>
                                    </div>
                                    <div class="d-grid">
                                        <button type="submit" class="btn btn-success btn-lg" id="btnGenerar">
                                            <i class="bi bi-receipt-cutoff me-2"></i>
                                            Generar Comprobante
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </main>

        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script>
        $(document).ready(function() {
            calcularTotales();
            function calcularTotales() {
                let subtotal = 0;
                $('#detallesTable tbody tr').each(function() {
                    const $row = $(this);
                    const cantidad = parseFloat($row.find('input[name*="cantidad"]').val()) || 0;
                    const precio = parseFloat($row.find('input[name*="precioUnitario"]').val()) || 0;
                    subtotal += cantidad * precio;
                });
                const igv = subtotal * 0.18;
                const total = subtotal + igv;
                $('#subtotalDisplay').text('S/. ' + subtotal.toFixed(2));
                $('#igvDisplay').text('S/. ' + igv.toFixed(2));
                $('#totalDisplay').text('S/. ' + total.toFixed(2));
                $('#subtotal').val(subtotal.toFixed(2));
                $('#igv').val(igv.toFixed(2));
                $('#totalPagar').val(total.toFixed(2));
            }
            $('#comprobanteForm').on('submit', function(e) {
                const tipoComprobante = $('#tipoComprobante').val();
                if (!tipoComprobante) {
                    e.preventDefault();
                    alert('Debe seleccionar un tipo de comprobante (Boleta o Factura)');
                    $('#tipoComprobante').focus();
                    return false;
                }
                $('#btnGenerar').prop('disabled', true)
                    .html('<i class="bi bi-hourglass-split me-2"></i>Generando Comprobante...');
                // ¡Sin confirm! El formulario se enviará directamente.
            });
        });
    </script>
</body>
</html>